<!DOCTYPE HTML>
<html>
  <head>
     <body><canvas id="canvas1"></canvas></body>
    <script>
      var canvas = document.getElementById("canvas1")
      var ctx = canvas.getContext("2d")
        function createVid(image,meta,title,frame) {
          var imgArea = meta.width * meta.height
          if (imgArea < 37500000) {
            canvas.width = meta.width
            canvas.height = meta.height
          } else {
            var percentage = (37500000 / (imgArea / 100)) / 100
            canvas.width = meta.width * percentage
            canvas.height = meta.height * percentage
          }

            const frameRate = 10; // Frames per second
            const recorder = new MediaRecorder(canvas.
              captureStream(frameRate),
              { mimeType: 'video/webm' });
            const chunks = [];

            recorder.ondataavailable = function (e) {
              chunks.push(e.data);
            };

            recorder.onstop = function() {
              console.log(chunks[0].size)
              if (chunks[0].size > 217) {
                var blob = new Blob(chunks,
                                      { type: 'video/webm' })
                  var video = document.createElement('video');
                  video.preload = 'metadata';
                 video.src = URL.createObjectURL(blob);
                  video.onloadedmetadata = function() {
                    console.log(video.src)
                    if (video.duration >= 1) {
                      window.top.showLink(blob,meta,title)
                      frame.remove()
                      if (video.duration == Infinity) {
                      video.currentTime = 1e101;
                      video.addEventListener("timeupdate", () => {
                        console.log("after workaround:", video.duration);
                        video.currentTime = 0;
                      }, { once: true });
                      }
                    } else {
                      createVid(image,meta,title,frame)
                    }
                  }
              } else {
               setTimeout(function() {createVid(image,meta,title,frame)},100)
              }
            };
            ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
            recorder.start();
            setTimeout(function() {
              recorder.stop()
            },1000)
        }
    </script>
  </head>
</html>
