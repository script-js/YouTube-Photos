<!DOCTYPE HTML>
<html>
  <head>
     <body></body>
    <script>
      var canvas = document.createElement("canvas")
      var ctx = canvas.getContext("2d")
        function createVid(image,meta,title,frame) {
          if ((meta.width * meta.height) < 37500000) {
            canvas.width = meta.width
            canvas.height = meta.height
          } else {
                var height = image.naturalHeight;
                var width = image.naturalWidth;

                var gcd = (...arr) => {
                var _gcd = (x, y) => (!y ? x : gcd(y, x % y));
                   return [...arr].reduce((a, b) => _gcd(a, b));
                };

                var gcdResult = gcd(width, height);

                canvas.width = 1000
                canvas.style.aspectRatio = `${width / gcdResult} / ${height / gcdResult}`;
          }

            const frameRate = 10; // Frames per second
            const recorder = new MediaRecorder(canvas.
              captureStream(frameRate),
              { mimeType: 'video/webm' });
            const chunks = [];

            recorder.ondataavailable = function (e) {
              chunks.push(e.data);
            };

            recorder.onstop = function () {
              if (chunks[0].size > 217) {
                var blob = new Blob(chunks,
                                      { type: 'video/webm' })
                  var video = document.createElement('video');
                  video.preload = 'metadata';
                  
                  video.onloadedmetadata = function() {
                    if (video.duration >= 1 && video.duration != Infinity) {
                      window.top.showLink(blob,meta,title)
                      frame.remove()
                    } else {
                      createVid(image,meta,title,frame)
                    }
                    clearTimeout(abort)
                  }

                  video.src = URL.createObjectURL(blob);
                  var abort = setTimeout(function() {
                    console.log(image,blob)
                    createVid(image,meta,title,frame)    
                  },5000)
              } else {
                createVid(image,meta,title,frame)
              }
            };
            ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
            recorder.start();
            setTimeout(function() {
              recorder.stop()
            },1000)
        }
    </script>
  </head>
</html>
